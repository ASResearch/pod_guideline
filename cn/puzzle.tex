\section{谜题选择}
\label{ch:puzzle}
谜题（puzzle）在PoW协议中扮演重要角色。通常，PoW协议规定只有解决给定谜题的矿工拥有出块权，是一种抵抗女巫攻击的有效手段。有文章指出PoW本质是通过谜题实现一个分布式时钟\footnote{https://grisha.org/blog/2018/01/23/explaining-proof-of-work/}。

谜题的选择同样也面临各式各样的取舍：
\begin{itemize}
	\item 谜题固然需要一定的难度来防止女巫攻击，但另一方面，有研究表明对于任何算力竞赛模型，高难度的谜题存在马太效应，更容易造成大户垄断（51\%dominance）。
	
	\item 谜题的难度固然需要动态调整以适应不断升级的算力，但另一方面，动态难度会造成跳链现象（见章节\ref{ch:attack}）。同时，动态难度也会遭受所谓长程攻击（long-range attack），即攻击者从某远古区块开始一直以极低算力挖一条私链，因难度是动态的私链增长速率可以和主链一致，然后攻击者一定时间段突然加大算力，使私链长度大于主链。通常解决长程攻击的方式为矿工检测到分叉时，除简单的采取最长链原则外同时也要检测区块难度，以摒弃难度过低的链。
\end{itemize}

鉴于谜题在PoW协议中的重要作用，作为区块链共识设计者，了解包括比特币在内的多个PoW所采用的谜题及工作原理，优势劣势等，也是设计合理的PoW共识必不可少的一部分。

本章节主要针对Mimblewimble共识协议（Grin项目）所采取的谜题进行介绍并展开思考。该谜题名称叫cuckoo，发表在2015年FC上\cite{tromp2015cuckoo}。

比特币的挖矿工具经历了CPU，GPU，FPGA，ASIC四个阶段。现今有比特大陆等矿机公司已经本质上实现了比特币的算力垄断。而cuckoo旨在提出一种新的谜题，使得挖矿工具的更新停留在GPU这一步——只有1060以上显卡才能进行挖矿。

谜题的本质是验证（verification）与探索（proof attempt）的不对称性。比特币所采取的SHA256由于哈希函数的难逆性无疑符合条件。cuckoo采取的是随机图找环算法，通过引入内存带宽限制构建谜题的难度。具体步骤如下：
\begin{itemize}
	\item 图的生成。
	
	二部图的$N$个点已经给定，通过哈希函数随机生成二部图的$M$条边（大约$N/2$）。生成边的方式要满足一定的要求，可以理解为每条边是根据$(k,nonce)$的SHA512值决定，其中$k$为编号，$nonce$为矿工尝试的数字。验证时，一旦给出nonce则可还原出图中所有的边。
	
	\item 谜题目标。
	
	给定一个图，矿工需要给出一个长为$L$的环。验证时，一旦给出图以及$L$个点的编号，可以轻易验证环是否能形成。
	
	值得一提的是，从一个图里面寻找长为$L$的环是多项式时间可解的\footnote{$L$为偶数时，时间复杂度为$n^2$。$L$为奇数时，时间复杂度为$M(n)$，其中$M(n)$为计算矩阵乘法所需的时间复杂度。}。然而由于图的生成是完全随机的，且每个图大概率不存在长为$L$的环，故矿工仍然需要暴力搜索。
	
	\item 找环推荐算法。
	
    文章推荐算法包含两部分。
    \begin{itemize}
    	\item 减支部分
    	
    	所谓减支本质上是完成一个拓扑排序问题：去掉所有度数为1的以及相邻的边，重复上述过程直到所有点的度数$\geq 2$。由于上述减支过程需要存储每个点的度数，故需要进行大量内存读取。这就是该谜题能引入内存带宽限制的原因。
    	
    	文章同时也提出了其他的减支算法，$BFS(L)$和$BFS(L/2)$，能避免对每个点都记录信息，但会消耗更多的时间，是一种时间和存储的平衡（TMTO，time-memory trade-off）
    	
    	\item 找环部分。
    	
    	文章推荐的找环算法维护一个有向图森林，以类似并查集的方式将边逐条加入。一开始，所有孤立点各自都是一座森林。一旦一条边加入，如果两个端点属于两个不同森林，则将两个森林合并，通过维护森林中边的指向与每个节点的root值。当且仅当新加入边的两个端点属于同一森林时，则必存在一个环，可根据有向图路径找到该环并确定长度。
    	
    	值得一提的是，如果找出来环的长度不为$L$，则忽略该条边继续上述操作。这样虽然可能导致有的长为$L$的环被漏掉，但这种情形概率不高，作为一种概率性的算法仍能保证高效性\footnote{高效概率性算法在实际运作中比比皆是。一个经典的例子是质数判定问题$Prime()$。有研究已经证明该问题是多项式时间可解，但时间复杂度仍然很高。实际运行时人们仍然选择用费马小定理进行判断。后者不能保证$100\%$正确但更快。另一个例子是线性规划问题，虽然已被证明椭圆算法能在多项式时间解决，但人们更多的还是采用单纯形法，后者不能保证多项式时间解决，但实际平均运行时间往往更低。}。
    \end{itemize}
\end{itemize}	

文章推荐的数据规模$N=2^{25}+2^{25}$，$L=42$

文章接下来给出了很多实验图表。这里不一一列出，仅简要介绍结论。
\begin{itemize}
	\item 计算哈希函数的时间开销随着节点规模增大而减小，最终低于$15\%$。（大部分时间用于找环）
	\item 存在$42$环的概率在$M/N>1/2$时剧烈增长。
	\item 内存的读开销随着已尝试nonce的百分比指数级上升，但写开销持平。
	\item 存在环的概率与$L$大约成反比。
\end{itemize}

总结：就目前而言cuckoo能限制矿机，但同时也需要考虑到新型矿机的可能性（如基于路由器的大带宽）。